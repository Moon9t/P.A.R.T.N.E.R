name: Monitor and Notify

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_run:
    workflows: ["Build and Test", "Code Quality"]
    types:
      - completed

jobs:
  monitor:
    name: Monitor Workflow Status
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'skipped' }}
    
    steps:
    - name: Check workflow outcome
      id: check
      run: |
        if [[ "${{ github.event.workflow_run.conclusion }}" == "failure" ]]; then
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "message=Workflow ${{ github.event.workflow_run.name }} failed" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=Workflow ${{ github.event.workflow_run.name }} succeeded" >> $GITHUB_OUTPUT
        fi

    - name: Create issue on failure
      if: steps.check.outputs.status == 'failed'
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'üö® Workflow Failure: ${{ github.event.workflow_run.name }}',
            body: `
            ## Workflow Failed
            
            **Workflow**: ${{ github.event.workflow_run.name }}
            **Run ID**: ${{ github.event.workflow_run.id }}
            **Commit**: ${{ github.event.workflow_run.head_sha }}
            **Branch**: ${{ github.event.workflow_run.head_branch }}
            
            [View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})
            
            **Action Required**: Please check the logs and fix the issues.
            `,
            labels: ['bug', 'ci-failure', 'automated']
          });
          console.log('Created issue:', issue.data.number);

  notify-status:
    name: Notify Build Status
    runs-on: ubuntu-latest
    if: always()
    needs: [monitor]
    
    steps:
    - name: Send status summary
      run: |
        echo "üìä Workflow Status Report"
        echo "========================="
        echo "Event: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "Actor: ${{ github.actor }}"
        echo "SHA: ${{ github.sha }}"
        
        if [[ "${{ needs.monitor.result }}" == "failure" ]]; then
          echo "‚ùå Build failed - Issue created"
        else
          echo "‚úÖ Build successful"
        fi
